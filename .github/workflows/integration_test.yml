name: Integration Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  fabric-client-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Build Fabric mod
        run: ./gradlew :fabric:build -q

      - name: Stage mod for testing
        run: |
          mkdir -p run/mods
          find platforms/fabric/build/libs -name "maestro-fabric-*.jar" ! -name "*-dev*" ! -name "*-shadow*" ! -name "*-unoptimized*" -exec cp {} run/mods/ \;

      - name: Run Minecraft client test
        uses: headlesshq/mc-runtime-test@4.1.0
        with:
          mc: 1.21.4
          modloader: fabric
          regex: .*fabric.*
          java: 21
          mc-runtime-test: fabric
          xvfb: true

  neoforge-client-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Build NeoForge mod
        run: ./gradlew :neoforge:build -q

      - name: Stage mod for testing
        run: |
          mkdir -p run/mods
          find platforms/neoforge/build/libs -name "maestro-neoforge-*.jar" ! -name "*-dev*" ! -name "*-shadow*" ! -name "*-unoptimized*" -exec cp {} run/mods/ \;

      - name: Run Minecraft client test
        uses: headlesshq/mc-runtime-test@4.1.0
        with:
          mc: 1.21.4
          modloader: neoforge
          regex: .*neoforge.*
          java: 21
          mc-runtime-test: neoforge
          xvfb: true
